{%- from "etcd/map.jinja" import server with context %}

dashboard:
{%- if server.monitoring is defined %}
  {%- set backend = server.monitoring.get('backend') %}
  {%- if backend is string %}
    {%- set backend = [backend] %}
  {%- endif %}
{%- else %}
{# legacy StackLight behavior #}
{% set backend = ['influxdb'] %}
{%- endif %}

{%- if 'prometheus' in backend %}
  etcd-cluster-prometheus:
    format: json
    template: etcd/files/grafana_dashboards/etcd_prometheus.json.json
{%- endif %}
{%- if 'influxdb' in backend %}
  etcd:
    format: json
    template: etcd/files/grafana_dashboards/etcd_influxdb.json
  main:
    row:
      etcd-control-plane:
        title: Etcd Cluster
        panel:
          etcd:
            title: Etcd
            links:
            - dashboard: Etcd
              title: Etcd
              type: dashboard
            target:
              cluster_status:
                rawQuery: true
                query: SELECT last(value) FROM cluster_status WHERE cluster_name = 'etcd' AND environment_label = '$environment' AND $timeFilter GROUP BY time($interval) fill(null)
{%- endif %}
